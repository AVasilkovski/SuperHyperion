name: staging-schema-deploy

# Ops 1.0: Deploy schema to TypeDB Cloud staging on pushes to main.
# Isolated via GitHub Environment â€” PR workflows cannot access these secrets.

on:
  push:
    branches:
      - main
    paths:
      - 'src/schema/scientific_knowledge.tql'
      - 'scripts/apply_schema.py'
      - '.github/workflows/staging-schema-deploy.yml'

jobs:
  deploy-schema:
    runs-on: ubuntu-latest
    environment:
      name: staging

    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4

      - name: 'Set up Python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 'Install typedb-driver'
        run: |
          python -m pip install --upgrade pip
          pip install "typedb-driver==3.8.0"

      - name: 'Debug schema apply version'
        run: |
          echo "Workflow file SHA:"
          python - <<'PY'
          import hashlib, pathlib
          p = pathlib.Path(".github/workflows/staging-schema-deploy.yml")
          print(hashlib.sha256(p.read_bytes()).hexdigest())
          PY
          
          echo "Git HEAD:"
          git rev-parse --short HEAD
          
          echo "Workflow Content (partial):"
          cat .github/workflows/staging-schema-deploy.yml | sed -n '1,120p'
          
          python -c "import pathlib; p=pathlib.Path('scripts/apply_schema.py'); print('apply_schema bytes:', p.stat().st_size); print(p.read_text().splitlines()[0])"

      - name: 'Decode TypeDB root CA (if provided)'
        env:
          TYPEDB_ROOT_CA_B64: "${{ secrets.TYPEDB_ROOT_CA_B64 }}"
        run: |
          if [ -n "$TYPEDB_ROOT_CA_B64" ]; then
            echo "$TYPEDB_ROOT_CA_B64" | base64 -d > ca.pem
            echo "TYPEDB_ROOT_CA_PATH=$(pwd)/ca.pem" >> $GITHUB_ENV
            echo "CA decoded and set."
          else
            echo "No CA provided, skipping."
          fi

      - name: 'Apply schema to TypeDB Cloud staging'
        env:
          TYPEDB_ADDRESS: "${{ secrets.TYPEDB_ADDRESS }}"
          TYPEDB_DATABASE: "${{ secrets.TYPEDB_DATABASE }}"
          TYPEDB_USERNAME: "${{ secrets.TYPEDB_USERNAME }}"
          TYPEDB_PASSWORD: "${{ secrets.TYPEDB_PASSWORD }}"
          TYPEDB_TLS: 'true'
          # Optional manual overrides (keep for emergency; auto-migrate preferred)
          TYPEDB_UNDEFINE_OWNS: "${{ secrets.TYPEDB_UNDEFINE_OWNS || '' }}"
          TYPEDB_UNDEFINE_PLAYS: "${{ secrets.TYPEDB_UNDEFINE_PLAYS || '' }}"
        run: |
          set -euo pipefail

          SCHEMA_FILE="src/schema/scientific_knowledge.tql"
          echo "Using authoritative schema file: $SCHEMA_FILE"

          if [[ "$SCHEMA_FILE" == *"***"* || "$SCHEMA_FILE" == *"*"* ]]; then
            echo "ERROR: glob schema path is forbidden: $SCHEMA_FILE"
            exit 1
          fi

          if [ ! -f "$SCHEMA_FILE" ]; then
            echo "ERROR: schema file missing: $SCHEMA_FILE"
            ls -la src/schema || true
            exit 1
          fi

          UNDEFINE_ARGS=()

          IFS=',' read -ra UNDEFINE_PLAYS <<< "${TYPEDB_UNDEFINE_PLAYS:-}"
          for spec in "${UNDEFINE_PLAYS[@]}"; do
            [ -n "$spec" ] && UNDEFINE_ARGS+=(--undefine-plays "$spec")
          done

          IFS=',' read -ra UNDEFINES <<< "${TYPEDB_UNDEFINE_OWNS:-}"
          for spec in "${UNDEFINES[@]}"; do
            [ -n "$spec" ] && UNDEFINE_ARGS+=(--undefine-owns "$spec")
          done

          python scripts/apply_schema.py \
            --schema "$SCHEMA_FILE" \
            --address "$TYPEDB_ADDRESS" \
            --database "$TYPEDB_DATABASE" \
            --username "$TYPEDB_USERNAME" \
            --password "$TYPEDB_PASSWORD" \
            --auto-migrate-redeclarations \
            --scrub-only \
            "${UNDEFINE_ARGS[@]}"

          echo "Applying authoritative additive migrations..."
          python scripts/migrate.py \
             --database "$TYPEDB_DATABASE"
             
          echo "Asserting Schema Health Parity..."
          python scripts/schema_health.py --database "$TYPEDB_DATABASE" --output "ci_artifacts/schema/staging_schema_health.json"

      - name: 'Connectivity smoke check'
        env:
          TYPEDB_ADDRESS: "${{ secrets.TYPEDB_ADDRESS }}"
          TYPEDB_USERNAME: "${{ secrets.TYPEDB_USERNAME }}"
          TYPEDB_PASSWORD: "${{ secrets.TYPEDB_PASSWORD }}"
          TYPEDB_DATABASE: "${{ secrets.TYPEDB_DATABASE }}"
        run: |
          python - << 'EOF'
          import os, logging
          from typedb.driver import TypeDB, Credentials, DriverOptions
          
          # Silence driver logging noise
          logging.basicConfig(level=logging.INFO)
          
          addr = os.environ.get('TYPEDB_ADDRESS')
          user = os.environ.get('TYPEDB_USERNAME')
          pw = os.environ.get('TYPEDB_PASSWORD')
          db_name = os.environ.get('TYPEDB_DATABASE')
          
          ca = os.getenv('TYPEDB_ROOT_CA_PATH')
          
          creds = Credentials(user, pw)
          opts = DriverOptions(is_tls_enabled=True, tls_root_ca_path=ca)
          
          print(f"Connecting to {addr} (TLS=True)...")
          driver = TypeDB.driver(addr, creds, opts)
          try:
              dbs = [d.name for d in driver.databases.all()]
              print(f"Staging DBs: {dbs}")
              assert db_name in dbs, f"{db_name} not found!"
              print("Connectivity smoke: PASS")
          finally:
              driver.close()
          EOF

      - name: 'Upload Schema Execution Artifacts'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: staging-schema-artifacts-${{ github.run_id }}
          path: ci_artifacts/schema/
          retention-days: 7
