name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    # Ops 1.0: Ephemeral TypeDB Core service container
    services:
      typedb:
        image: typedb/typedb:3.7.3
        ports:
          - 1729:1729

    env:
      PYTHONPATH: .
      TYPEDB_HOST: localhost
      TYPEDB_PORT: "1729"
      TYPEDB_DATABASE: scientific_knowledge
      TYPEDB_USERNAME: admin
      TYPEDB_PASSWORD: password
      TYPEDB_TLS: "false"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip uninstall -y typedb || true
          pip install --no-cache-dir --force-reinstall "typedb-driver==3.7.0"
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Debug TypeDB driver surface
        run: |
          python -c "import typedb.driver as d; print('driver file:', d.__file__); print('attrs:', [a for a in dir(d) if a in ('TypeDB','TransactionType','Credentials','DriverOptions','SessionType')])"

      # Phase 16.3: WriteCap grep-ban — no agent except OntologySteward may write
      - name: Grep-ban unauthorized writes
        run: |
          VIOLATIONS=$(grep -rnE "(insert_to_graph|query_insert|query_delete)" \
            src/agents/ \
            --include="*.py" \
            --exclude="ontology_steward.py" \
            --exclude="base_agent.py" \
            || true)
          if [ -n "$VIOLATIONS" ]; then
            echo "::error::WriteCap violation — unauthorized write calls found:"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "✓ No unauthorized write calls found"

      - name: Wait for TypeDB gRPC readiness
        run: |
          python - << 'PY'
          import os, time, logging
          from typedb.driver import TypeDB, Credentials, DriverOptions

          # Silence driver logging noise
          logging.basicConfig(level=logging.INFO)
          
          host = os.environ.get('TYPEDB_HOST')
          port = os.environ.get('TYPEDB_PORT')
          
          if not host or not port:
              print("SKIP: TYPEDB_HOST/PORT missing. Skipping readiness probe in CI (likely PR/secret-less context).")
              raise SystemExit(0)

          addr = f"{host}:{port}"
          creds = Credentials("admin", "password")
          opts = DriverOptions(is_tls_enabled=False, tls_root_ca_path=None)

          last = None
          for i in range(1, 31):
              try:
                  driver = TypeDB.driver(addr, creds, opts)
                  _ = [d.name for d in driver.databases.all()]
                  driver.close()
                  print(f"TypeDB ready: {addr}")
                  raise SystemExit(0)
              except Exception as e:
                  last = e
                  print(f"waiting for TypeDB ({i}/30): {e}")
                  time.sleep(2)
          raise SystemExit(f"TypeDB not ready: {last}")
          PY

      - name: Apply schema (CI TypeDB Core)
        run: |
          python scripts/apply_schema.py --schema src/schema/scientific_knowledge.tql --database "$TYPEDB_DATABASE"

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short

      - name: OPS-1.2 commit trust gate
        run: |
          python scripts/ops12_ci_trust_gates.py --gate commit --out-dir ci_artifacts/commit --json

      - name: OPS-1.2 hold trust gate
        run: |
          python scripts/ops12_ci_trust_gates.py --gate hold --out-dir ci_artifacts/hold --json

      - name: OPS-1.3 trust gate summary
        run: |
          python scripts/ops13_trust_gate_summary.py --in-dir ci_artifacts --out ci_artifacts/trust_gate_summary.json

      - name: TRUST-1.0.4 policy conflict guardrail
        run: |
          python -m src.cli.main policy conflicts --bundles ci_artifacts --policies src.policies.builtin --out ci_artifacts/conflicts --json --fail-on-severity error

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            .pytest_cache/
            *.log
            ci_artifacts/**
          retention-days: 7

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: pip install ruff

      - name: Run linter
        run: ruff check src/ tests/ --output-format=github
