name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    # Ops 1.0: Ephemeral TypeDB Core service container
    services:
      typedb:
        image: typedb/typedb:3.8.0
        ports:
          - 1729:1729
          - 8000:8000

    env:
      PYTHONPATH: .
      TYPEDB_HOST: localhost
      TYPEDB_PORT: "1729"
      TYPEDB_DATABASE: scientific_knowledge
      TYPEDB_USERNAME: admin
      TYPEDB_PASSWORD: password
      TYPEDB_TLS: "false"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip uninstall -y typedb || true
          pip install --no-cache-dir --force-reinstall "typedb-driver==3.8.0"
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Debug TypeDB driver surface
        run: |
          python -c "import typedb.driver as d; print('driver file:', d.__file__); print('attrs:', [a for a in dir(d) if a in ('TypeDB','TransactionType','Credentials','DriverOptions','SessionType')])"

      # Phase 16.3: WriteCap grep-ban — no agent except OntologySteward may write
      - name: Grep-ban unauthorized writes
        run: |
          VIOLATIONS=$(grep -rnE "(insert_to_graph|query_insert|query_delete)" \
            src/agents/ \
            --include="*.py" \
            --exclude="ontology_steward.py" \
            --exclude="base_agent.py" \
            || true)
          if [ -n "$VIOLATIONS" ]; then
            echo "::error::WriteCap violation — unauthorized write calls found:"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "✓ No unauthorized write calls found"

      - name: Wait for TypeDB gRPC readiness
        run: |
          python - << 'PY'
          import os
          import socket
          import sys
          import time

          host = os.environ.get('TYPEDB_HOST', 'localhost')
          port = int(os.environ.get('TYPEDB_PORT', '1729'))

          deadline = time.time() + 90
          while time.time() < deadline:
              try:
                  with socket.create_connection((host, port), timeout=2):
                      print(f"TypeDB is up on {host}:{port}")
                      raise SystemExit(0)
              except OSError:
                  time.sleep(1)

          print(f"TypeDB did not start in time on {host}:{port}", file=sys.stderr)
          raise SystemExit(1)
          PY

      - name: Debug TypeDB networking (on failure)
        if: failure()
        run: |
          ss -lntp | grep 1729 || true
          docker ps -a
          docker logs "${{ job.services.typedb.id }}" | tail -200 || true

      - name: Additive Linter Pre-flight
        run: |
          python scripts/additive_linter.py --base main --head HEAD

      - name: Apply schema (CI TypeDB Core)
        run: |
          SCHEMA_FILE="src/schema/scientific_knowledge.tql"
          python scripts/apply_schema.py --schema "$SCHEMA_FILE" --database "$TYPEDB_DATABASE"

      - name: Verify Migration Safety (Dry-Run)
        run: |
          python scripts/migrate.py --database "$TYPEDB_DATABASE" --dry-run

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short

      - name: OPS-1.2 commit trust gate
        run: |
          python scripts/ops12_ci_trust_gates.py --gate commit --out-dir ci_artifacts/commit --json

      - name: OPS-1.2 hold trust gate
        run: |
          python scripts/ops12_ci_trust_gates.py --gate hold --out-dir ci_artifacts/hold --json

      - name: OPS-1.3 trust gate summary
        run: |
          python scripts/ops13_trust_gate_summary.py --in-dir ci_artifacts --out ci_artifacts/trust_gate_summary.json

      - name: TRUST-1.0.4 policy conflict guardrail
        run: |
          python -m src.cli.main policy conflicts --bundles ci_artifacts --policies src.policies.builtin --out ci_artifacts/conflicts --json --fail-on-severity error

      - name: TRUST-1.0.3 compliance report artifact
        run: |
          python -m src.cli.main compliance report --bundles ci_artifacts --out ci_artifacts/compliance/compliance_report.json --format json

      - name: OPS artifact schema validation gate
        run: |
          python scripts/validate_ci_artifacts.py --root ci_artifacts --schemas schemas

      - name: Upload CI trust artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts-${{ github.run_id }}
          path: |
            ci_artifacts/**
            schemas/**
          retention-days: 7

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            .pytest_cache/
            *.log
          if-no-files-found: ignore
          retention-days: 7

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: pip install ruff

      - name: Run linter
        run: ruff check src/ tests/ --output-format=github
