name: staging-schema-deploy

# Ops 1.0: Deploy schema to TypeDB Cloud staging on pushes to main.
# Isolated via GitHub Environment â€” PR workflows cannot access these secrets.

on:
  push:
    branches:
      - main
    paths:
      - 'src/schema/**'
      - 'scripts/apply_schema.py'
      - '.github/workflows/staging-schema-deploy.yml'

jobs:
  deploy-schema:
    runs-on: ubuntu-latest
    environment:
      name: staging

    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4

      - name: 'Set up Python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 'Install typedb-driver'
        run: |
          python -m pip install --upgrade pip
          pip install "typedb-driver==3.8.0"

      - name: 'Debug schema apply version'
        run: |
          git rev-parse --short HEAD
          python -c "import pathlib; p=pathlib.Path('scripts/apply_schema.py'); print('apply_schema bytes:', p.stat().st_size); print(p.read_text().splitlines()[0])"

      - name: 'Decode TypeDB root CA (if provided)'
        env:
          TYPEDB_ROOT_CA_B64: "${{ secrets.TYPEDB_ROOT_CA_B64 }}"
        run: |
          if [ -n "$TYPEDB_ROOT_CA_B64" ]; then
            echo "$TYPEDB_ROOT_CA_B64" | base64 -d > ca.pem
            echo "TYPEDB_ROOT_CA_PATH=$(pwd)/ca.pem" >> $GITHUB_ENV
            echo "CA decoded and set."
          else
            echo "No CA provided, skipping."
          fi

      - name: 'Apply schema to TypeDB Cloud staging'
        env:
          TYPEDB_ADDRESS: "${{ secrets.TYPEDB_ADDRESS }}"
          TYPEDB_DATABASE: "${{ secrets.TYPEDB_DATABASE }}"
          TYPEDB_USERNAME: "${{ secrets.TYPEDB_USERNAME }}"
          TYPEDB_PASSWORD: "${{ secrets.TYPEDB_PASSWORD }}"
          TYPEDB_TLS: 'true'
          # Optional guarded legacy migration for inherited plays/owns conflicts.
          # Comma-separated list of specs.
          TYPEDB_UNDEFINE_PLAYS: "validation-evidence:session-has-evidence:evidence"
          TYPEDB_UNDEFINE_OWNS: "validation-evidence:entity-id,validation-evidence:template-qid,validation-evidence:template-id,validation-evidence:scope-lock-id,validation-evidence:confidence-score,validation-evidence:success,validation-evidence:json,validation-evidence:created-at,validation-evidence:claim-id,validation-evidence:execution-id"
        run: |
          UNDEFINE_ARGS=()

          IFS=',' read -ra UNDEFINE_PLAYS <<< "$TYPEDB_UNDEFINE_PLAYS"
          for spec in "${UNDEFINE_PLAYS[@]}"; do
            if [ -n "$spec" ]; then
              UNDEFINE_ARGS+=(--undefine-plays "$spec")
            fi
          done

          IFS=',' read -ra UNDEFINES <<< "$TYPEDB_UNDEFINE_OWNS"
          for spec in "${UNDEFINES[@]}"; do
            if [ -n "$spec" ]; then
              UNDEFINE_ARGS+=(--undefine-owns "$spec")
            fi
          done

          python scripts/apply_schema.py \
            --schema src/schema/scientific_knowledge.tql \
            --address "$TYPEDB_ADDRESS" \
            --database "$TYPEDB_DATABASE" \
            --username "$TYPEDB_USERNAME" \
            --password "$TYPEDB_PASSWORD" \
            "${UNDEFINE_ARGS[@]}"

      - name: 'Connectivity smoke check'
        env:
          TYPEDB_ADDRESS: "${{ secrets.TYPEDB_ADDRESS }}"
          TYPEDB_USERNAME: "${{ secrets.TYPEDB_USERNAME }}"
          TYPEDB_PASSWORD: "${{ secrets.TYPEDB_PASSWORD }}"
          TYPEDB_DATABASE: "${{ secrets.TYPEDB_DATABASE }}"
        run: |
          python - << 'EOF'
          import os, logging
          from typedb.driver import TypeDB, Credentials, DriverOptions
          
          # Silence driver logging noise
          logging.basicConfig(level=logging.INFO)
          
          addr = os.environ.get('TYPEDB_ADDRESS')
          user = os.environ.get('TYPEDB_USERNAME')
          pw = os.environ.get('TYPEDB_PASSWORD')
          db_name = os.environ.get('TYPEDB_DATABASE')
          
          ca = os.getenv('TYPEDB_ROOT_CA_PATH')
          
          creds = Credentials(user, pw)
          opts = DriverOptions(is_tls_enabled=True, tls_root_ca_path=ca)
          
          print(f"Connecting to {addr} (TLS=True)...")
          driver = TypeDB.driver(addr, creds, opts)
          try:
              dbs = [d.name for d in driver.databases.all()]
              print(f"Staging DBs: {dbs}")
              assert db_name in dbs, f"{db_name} not found!"
              print("Connectivity smoke: PASS")
          finally:
              driver.close()
          EOF
