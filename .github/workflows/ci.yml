name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    # Ephemeral TypeDB — pinned to match docker-compose + driver
    services:
      typedb:
        image: typedb/typedb:3.7.3
        ports:
          - 1729:1729

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Remove any conflicting typedb package if present
          pip uninstall -y typedb || true
          # Force reinstall the exact driver version for a deterministic API surface
          pip install --force-reinstall "typedb-driver==3.7.0"
          pip install pytest pytest-cov pytest-asyncio

      - name: Debug TypeDB driver import surface
        run: |
          python -c "import typedb, typedb.driver; print('typedb:', typedb.__file__); print('typedb.driver:', typedb.driver.__file__); print('has SessionType:', hasattr(typedb.driver,'SessionType')); print('has TransactionType:', hasattr(typedb.driver,'TransactionType')); print('dir subset:', [x for x in dir(typedb.driver) if 'Type' in x or 'Session' in x or 'Transaction' in x])"

      # Driver-based readiness loop + create DB + load schema (no sleep, no mock)
      - name: Initialize TypeDB schema (CI)
        env:
          PYTHONPATH: .
          TYPEDB_HOST: localhost
          TYPEDB_PORT: 1729
          TYPEDB_DATABASE: scientific_knowledge
        run: python scripts/init_ci_db.py

      - name: Run tests
        env:
          PYTHONPATH: .
          TYPEDB_HOST: localhost
          TYPEDB_PORT: 1729
          TYPEDB_DATABASE: scientific_knowledge
        run: pytest tests/ -v --tb=short

      # Phase 16.3: WriteCap grep-ban — no agent except OntologySteward may write
      - name: Grep-ban unauthorized writes
        run: |
          VIOLATIONS=$(grep -rnE "(insert_to_graph|query_insert|query_delete)" \
            src/agents/ \
            --include="*.py" \
            --exclude="ontology_steward.py" \
            --exclude="base_agent.py" \
            || true)
          if [ -n "$VIOLATIONS" ]; then
            echo "::error::WriteCap violation — unauthorized write calls found:"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "✓ No unauthorized write calls found"

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            .pytest_cache/
            *.log
          retention-days: 7

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: pip install ruff

      - name: Run linter
        run: ruff check src/ tests/ --output-format=github
